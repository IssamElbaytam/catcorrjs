!function(t){function e(t,e){function r(t){d3.select(this).call(t)}function a(){g.each(r),d3.select("aside.catcorr #active").text(s(u.value()))}function n(t){function e(e){function n(t){for(var e,a=[],n=-1,l=t.length;++n<l;)e=t[n],a.push("M",r(e.key-.5)+1,",",b,"V",d(e.value),"h",x-2,"V",b);return a.join("")}function l(t){for(var e,a,n=[],l=-1,s=t.length,o=u.value();++l<s;)e=t[l],a=o/c.length*i.__all__[l],n.push("M",r(e.key-.5),",",d(a),"h",x);return n.join("")}function s(t){var e=+("e"==t),r=e?1:-1,a=b/3;return"M"+.5*r+","+a+"A6,6 0 0 "+e+" "+6.5*r+","+(a+6)+"V"+(2*a-6)+"A6,6 0 0 "+e+" "+.5*r+","+2*a+"Z"+"M"+2.5*r+","+(a+8)+"V"+(2*a-8)+"M"+4.5*r+","+(a+8)+"V"+(2*a-8)}var g=d3.max(r.range()),b=d3.max(d.range());h.tickValues(d3.range(0,d3.keys(r.labels).length)),e.each(function(){var e=d3.select(this),c=e.select("g");if(c.empty()){e.select(".title").append("a").attr("href","javascript:reset("+p+")").attr("class","catcorr reset").text("reset").style("display","none"),c=e.append("svg").attr("width",g+o.left+o.right).attr("height",b+o.top+o.bottom).append("g").attr("transform","translate("+o.left+","+o.top+")"),c.append("clipPath").attr("id","clip-"+p).append("rect").attr("width",g).attr("height",b),c.selectAll(".bar").data(["all_background","background","foreground","all_proportion"]).enter().append("path").attr("class",function(e,r){return 0===r?"catcorr "+e+" all_bar "+t.type:3===r?"catcorr "+e+" all_bar "+t.type:"catcorr "+e+" bar "+t.type}).datum(i.all()),c.selectAll(".foreground.bar").attr("clip-path","url(#clip-"+p+")"),c.append("g").attr("class","catcorr axis").attr("transform","translate(0,"+b+")").call(h),c.selectAll("g.axis text").text(function(t){var e=20,a=r.labels[t];if(void 0===a)return"";if(a.length>e){var n=a.substring(0,e-3).split(" ");a=n.slice(0,n.length-1).join(" "),a+="..."}return a});var u=c.append("g").attr("class","catcorr brush").call(f);u.selectAll("rect").attr("height",b),u.selectAll(".resize").append("path").attr("d",s)}if(a)if(a=!1,c.selectAll(".brush").call(f),e.select(".title a").style("display",f.empty()?"none":null),f.empty())c.selectAll("#clip-"+p+" rect").attr("x",0).attr("width",g);else{var d=f.extent();c.selectAll("#clip-"+p+" rect").attr("x",r(d[0])).attr("width",r(d[1])-r(d[0]))}c.selectAll(".bar").attr("d",n),c.selectAll(".all_background.all_bar").attr("d",function(t,e){var r=d3.select(this).attr("d");return null===r?n(t,e):r}),c.selectAll(".all_proportion.all_bar").attr("d",l)})}n.id||(n.id=0);var r,a,l,i,s,o={top:10,right:10,bottom:20,left:10},d=m[n.id],p=n.id++,h=d3.svg.axis().orient("bottom").tickSize(6,0,0),f=d3.svg.brush();return f.on("brushstart.chart",function(){var t=d3.select(this.parentNode.parentNode.parentNode);t.select(".title a").style("display",null)}),f.on("brush.chart",function(){var t=d3.select(this.parentNode),e=f.extent();s&&t.select(".brush").call(f.extent(e=e.map(s))).selectAll(".resize").style("display",null),t.select("#clip-"+p+" rect").attr("x",r(e[0])).attr("width",r(e[1])-r(e[0])),l.filterRange(e)}),f.on("brushend.chart",function(){if(f.empty()){var t=d3.select(this.parentNode.parentNode.parentNode);t.select(".title a").style("display","none"),t.select("#clip-"+p+" rect").attr("x",null).attr("width","100%"),l.filterAll()}}),e.margin=function(t){return arguments.length?(o=t,e):o},e.x=function(t){return arguments.length?(r=t,h.scale(r),f.x(r),e):r},e.y=function(t){return arguments.length?(d=t,e):d},e.dimension=function(t){return arguments.length?(l=t,e):l},e.filter=function(t){return t?(f.extent(t),l.filterRange(t)):(f.clear(),l.filterAll()),a=!0,e},e.group=function(t){return arguments.length?(i=t,e):i},e.round=function(t){return arguments.length?(s=t,e):s},d3.rebind(e,f,"on")}var l=e.questions,c=e.responses,i={};l.forEach(function(t){i[t.number]={},t.choices.forEach(function(e,r){i[t.number][e]=r})}),c.forEach(function(t){l.forEach(function(e){t[e.number]=i[e.number][t[e.number]]})}),l.forEach(function(e){d3.select(t).append("div").attr("id",e.number+"-chart").attr("class","catcorr chart").append("div").attr("class","title").text(e.number+". "+e.text)});var s=d3.format(",d"),o=crossfilter(c),u=o.groupAll(),d=[],p=[];l.forEach(function(t,e){d.push(o.dimension(function(e){return e[t.number]})),p.push(d[e].group())}),p.forEach(function(t){t.__all__=t.all().map(function(t){return t.value})});var h,f,g,b=[],m=[],v=[],x=80;l.forEach(function(t,e){var r={};t.choices.forEach(function(t,e){r[e]=t});var a=0,l=t.choices.length-1;h=d3.scale.linear().domain([-.5,l+.5]).rangeRound([0,x*(l-a+1)]),h.labels=r,b.push(h),f=d3.scale.linear().range([100,0]).domain([0,p[e].top(1)[0].value]),m.push(f),g=n(t).dimension(d[e]).group(p[e]).x(h),v.push(g)});var g=d3.selectAll(".catcorr.chart").data(v).each(function(t){t.on("brush",a).on("brushend",a)});d3.select(t).append("aside").attr("id","totals").attr("class","catcorr").html("you've selected <br/> <span id='active'>-</span> <span>/</span> <span id='total'>-</span> <br/> respondents."),d3.selectAll("aside.catcorr #total").text(s(o.size())),a(),window.filter=function(t){t.forEach(function(t,e){v[e].filter(t)}),a()},window.reset=function(t){v[t].filter(null),a()}}e.version="0.1.0",t.catcorr=e}(this);