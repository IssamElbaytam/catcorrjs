!function(t){function e(t,e){function r(t){d3.select(this).call(t)}function a(){g.each(r),d3.select("aside.catcorr #active").text(i(u.value()))}function n(t){function e(e){function n(t){for(var e,a=[],n=-1,l=t.length;++n<l;)e=t[n],a.push("M",r(e.key-.5)+x,",",_,"V",d(e.value),"h",y-2*x,"V",_);return a.join("")}function l(){var t,e=d3.sum(s.__all__),r=u.value(),a=[0],n=1;s.__all__.forEach(function(r){t=(r+n)/(e+n*s.__all__.length),a.push(a[a.length-1]+t)}),a.splice(0,1),a[a.length-1]=1;var l,c,i,o=[];for(l=0;250>l;l++){for(i={},a.forEach(function(t,e){i[e]=0}),c=0;r>c;c++)i[d3.bisect(a,Math.random())]+=1;o.push(i)}var d,h,p=[];return a.forEach(function(t,e){var r=[];o.forEach(function(t){r.push(t[e])}),r.sort(d3.ascending),d=r[Math.floor(r.length*(1-.95)/2)],h=r[Math.floor(.975*r.length)],p.push([d,h])}),p}function i(t){return"M"+(t-y/2)+","+-o.top+"h"+y+"v"+(o.top+d.range()+o.bottom)+"h"+-y+"Z"}function v(t){var e=d3.select(this.parentNode);e.selectAll(".asterisk").remove();var a,n,o,h,p,f=[],g=-1,v=t.length,m=u.value();if(m!=c.length)var p=l(t);for(;++g<v;)a=t[g],n=m/c.length*s.__all__[g],f.push("M",r(a.key-.5)+x,",",d(n),"h",y-2*x),p&&(o=p[g][0],h=p[g][1],f.push("M",r(a.key),",",d(o),"v",d(h)-d(o)),(a.value<o||h<a.value)&&e.insert("path","path.catcorr.all_bar").attr("class","catcorr asterisk").attr("d",i(r(a.key))));return f.join("")}function m(t){var e=+("e"==t),r=e?1:-1,a=_/3;return"M"+.5*r+","+a+"A6,6 0 0 "+e+" "+6.5*r+","+(a+6)+"V"+(2*a-6)+"A6,6 0 0 "+e+" "+.5*r+","+2*a+"Z"+"M"+2.5*r+","+(a+8)+"V"+(2*a-8)+"M"+4.5*r+","+(a+8)+"V"+(2*a-8)}var b=d3.max(r.range()),_=d3.max(d.range());f.tickValues(d3.range(0,d3.keys(r.labels).length)),e.each(function(){var e=d3.select(this),l=e.select("g");if(l.empty()){e.select(".title").append("a").attr("href","javascript:reset("+p+")").attr("class","catcorr reset").text("reset").style("display","none"),l=e.append("svg").attr("width",b+o.left+o.right).attr("height",_+o.top+o.bottom).append("g").attr("transform","translate("+o.left+","+o.top+")");var c=e.select("svg").insert("pattern","g").attr("id","diagonalHatch").attr("patternUnits","userSpaceOnUse").attr("width",10).attr("height",10);c.append("path").attr("class","catcorr hatching").attr("d","M-1,1l2,-2M0,10l10,-10M9,11l2,-2"),h&&l.call(h),l.append("clipPath").attr("id","clip-"+p).append("rect").attr("width",b).attr("height",_),l.selectAll(".bar").data(["all_background","background","foreground","all_proportion"]).enter().append("path").attr("class",function(e,r){return 0===r?"catcorr "+e+" all_bar "+t.type:3===r?"catcorr "+e+" all_bar "+t.type:"catcorr "+e+" bar "+t.type}).datum(s.all()),l.selectAll(".foreground.bar").attr("clip-path","url(#clip-"+p+")"),l.append("g").attr("class","catcorr axis").attr("transform","translate(0,"+_+")").call(f);var i=l.selectAll("g.axis text").text(function(t){var e=20,a=r.labels[t];if(void 0===a)return"";if(a.length>e){var n=a.substring(0,e-3).split(" ");a=n.slice(0,n.length-1).join(" "),a+="..."}return a});h&&(h.html(function(t){return r.labels[t]}),i.on("mouseover",h.show).on("mouseout",h.hide));var u=l.append("g").attr("class","catcorr brush").call(g);u.selectAll("rect").attr("fill","url(#diagonalHatch)").attr("height",_),u.selectAll(".resize").append("path").attr("d",m)}if(a)if(a=!1,l.selectAll(".brush").call(g),e.select(".title a").style("display",g.empty()?"none":null),g.empty())l.selectAll("#clip-"+p+" rect").attr("x",0).attr("width",b);else{var d=g.extent();l.selectAll("#clip-"+p+" rect").attr("x",r(d[0])).attr("width",r(d[1])-r(d[0]))}l.selectAll(".bar").attr("d",n),l.selectAll(".all_background.all_bar").attr("d",function(t,e){var r=d3.select(this).attr("d");return null===r?n(t,e):r}),g.empty()&&l.selectAll(".all_proportion.all_bar").attr("d",v)})}n.id||(n.id=0);var r,a,l,s,i,o={top:10,right:10,bottom:20,left:10},d=m,h=b[n.id],p=n.id++,f=d3.svg.axis().orient("bottom").tickSize(6,0,0),g=d3.svg.brush();return g.on("brushstart.chart",function(){var t=d3.select(this.parentNode.parentNode.parentNode);t.select(".title a").style("display",null)}),g.on("brush.chart",function(){var t=d3.select(this.parentNode),e=g.extent();i&&t.select(".brush").call(g.extent(e=e.map(i))).selectAll(".resize").style("display",null),t.select("#clip-"+p+" rect").attr("x",r(e[0])).attr("width",r(e[1])-r(e[0])),l.filterRange(e)}),g.on("brushend.chart",function(){if(g.empty()){var t=d3.select(this.parentNode.parentNode.parentNode);t.select(".title a").style("display","none"),t.select("#clip-"+p+" rect").attr("x",null).attr("width","100%"),l.filterAll()}}),e.margin=function(t){return arguments.length?(o=t,e):o},e.x=function(t){return arguments.length?(r=t,f.scale(r),g.x(r),e):r},e.y=function(t){return arguments.length?(d=t,e):d},e.dimension=function(t){return arguments.length?(l=t,e):l},e.filter=function(t){return t?(g.extent(t),l.filterRange(t)):(g.clear(),l.filterAll()),a=!0,e},e.group=function(t){return arguments.length?(s=t,e):s},e.round=function(t){return arguments.length?(i=t,e):i},d3.rebind(e,g,"on")}var l=e.questions,c=e.responses,s={};l.forEach(function(t){s[t.number]={},t.choices.forEach(function(e,r){s[t.number][e]=r})}),c.forEach(function(t){l.forEach(function(e){t[e.number]=s[e.number][t[e.number]]})}),l.forEach(function(e){d3.select(t).append("div").attr("id",e.number+"-chart").attr("class","catcorr chart").append("div").attr("class","title").text(e.number+". "+e.text)});var i=d3.format(",d"),o=crossfilter(c),u=o.groupAll(),d=[],h=[];l.forEach(function(t,e){d.push(o.dimension(function(e){return e[t.number]})),h.push(d[e].group())}),h.forEach(function(t){t.__all__=t.all().map(function(t){return t.value})});var p,f,g,v=[],m=d3.scale.linear().range([100,0]),b=[],_=[],y=80,x=2;l.forEach(function(t,e){var r={};t.choices.forEach(function(t,e){r[e]=t}),d3.tip&&(f=d3.tip().attr("class","d3-tip").direction("s").html(function(t){return"awesome "+t}),b.push(f));var a=0,l=t.choices.length-1;p=d3.scale.linear().domain([-.5,l+.5]).rangeRound([0,y*(l-a+1)]),p.labels=r,v.push(p),m.domain([0,d3.max([m.domain()[1],h[e].top(1)[0].value])]),g=n(t).dimension(d[e]).group(h[e]).x(p),_.push(g)});var g=d3.selectAll(".catcorr.chart").data(_).each(function(t){t.on("brush",a).on("brushend",a)});d3.select(t).append("aside").attr("id","totals").attr("class","catcorr").html("you've selected <br/> <span id='active'>-</span> <span>/</span> <span id='total'>-</span> <br/> respondents."),d3.selectAll("aside.catcorr #total").text(i(o.size())),a(),window.filter=function(t){t.forEach(function(t,e){_[e].filter(t)}),a()},window.reset=function(t){_[t].filter(null),a()}}e.version="0.1.0",t.catcorr=e}(this);